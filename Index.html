<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solana Ko-fi Clone</title>
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
<style>
  body { font-family: sans-serif; display:flex; justify-content:center; align-items:center; min-height:100vh; background:#fef3c7;}
  .container { text-align:center; padding:2rem; background:#fff8e1; border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,0.1); max-width:400px;}
  .profile-img { width:120px; border-radius:50%; margin-bottom:1rem;}
  button { background:#ff6b6b; color:white; padding:.75rem 1.5rem; font-size:1rem; border:none; border-radius:8px; cursor:pointer; margin:0.5rem;}
  button:disabled { background:#ccc; cursor:not-allowed;}
  button:hover:not(:disabled) { background:#ff3b3b; }
</style>
</head>
<body>

<div class="container">
  <img id="profile-img" src="" alt="Profile Image" class="profile-img">
  <h1 id="creator-name">Loading...</h1>
  <p id="creator-bio">Please wait...</p>

  <p id="coffeePrice"></p>
  <p id="platformFee"></p>

  <button id="connectWalletBtn">Connect Wallet</button>
  <button id="buyCoffeeBtn" disabled>Buy Coffee</button>

  <p id="thankYouMsg" style="display:none;">â˜• Thank you for your support!</p>
</div>

<script>
const { Connection, PublicKey, clusterApiUrl, Transaction, SystemProgram, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection(clusterApiUrl("devnet")); // change to mainnet-beta for real SOL

// CONFIG
const PLATFORM_WALLET = "FILL_WITH_YOUR_PLATFORM_WALLET_PUBLIC_KEY"; // replace with your wallet
const PLATFORM_FEE_USD = 0.10; // $0.10

let walletPublicKey = null;

// MOCK CREATOR DATA (all in one file now)
const creators = [
  {
    handle: "JaneDoe",
    name: "Jane Doe",
    wallet: "5G9hKABCDE1234567890ABCDE1234567890ABCDE12345",
    bio: "Digital artist & storyteller",
    coffeePriceSOL: 0.01
  },
  {
    handle: "AlexMusic",
    name: "Alex Music",
    wallet: "7X1ABCDXYZ1234567890ABCDXYZ1234567890ABCDXYZ12",
    bio: "Indie musician",
    coffeePriceSOL: 0.01
  }
];

// DOM
const connectWalletBtn = document.getElementById("connectWalletBtn");
const buyCoffeeBtn = document.getElementById("buyCoffeeBtn");
const creatorNameEl = document.getElementById("creator-name");
const creatorBioEl = document.getElementById("creator-bio");
const coffeePriceEl = document.getElementById("coffeePrice");
const platformFeeEl = document.getElementById("platformFee");
const thankYouMsg = document.getElementById("thankYouMsg");

// --- Helpers ---
function getHandleFromURL() {
  const path = window.location.pathname.split('/');
  return path[path.length - 1]; // last part
}

async function getSolPriceUSD() {
  try {
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd");
    const data = await res.json();
    return data.solana.usd;
  } catch(err) {
    console.error(err);
    return 15; // fallback
  }
}

// Load creator
async function loadCreatorProfile() {
  const handle = getHandleFromURL() || "JaneDoe"; // default if root
  const creator = creators.find(c => c.handle.toLowerCase() === handle.toLowerCase());
  if(!creator) {
    creatorNameEl.textContent = "Creator Not Found";
    creatorBioEl.textContent = "";
    buyCoffeeBtn.disabled = true;
    return;
  }

  creatorNameEl.textContent = creator.name;
  creatorBioEl.textContent = creator.bio;
  coffeePriceEl.textContent = `Coffee price: ${creator.coffeePriceSOL} SOL`;

  const solPrice = await getSolPriceUSD();
  const platformFeeSOL = (PLATFORM_FEE_USD / solPrice).toFixed(6);
  platformFeeEl.textContent = `Platform fee: ${platformFeeSOL} SOL (~$${PLATFORM_FEE_USD})`;
  buyCoffeeBtn.dataset.platformFeeSOL = platformFeeSOL;
  buyCoffeeBtn.dataset.creatorWallet = creator.wallet;
  buyCoffeeBtn.dataset.coffeePriceSOL = creator.coffeePriceSOL;
}

// --- Wallet connect ---
connectWalletBtn.onclick = async () => {
  if(!window.solana) return alert("Phantom wallet not found!");
  try {
    const resp = await window.solana.connect();
    walletPublicKey = resp.publicKey;
    alert("Wallet connected: " + walletPublicKey.toString());
    buyCoffeeBtn.disabled = false;
  } catch(err) {
    console.error(err);
    alert("Wallet connection failed");
  }
};

// --- Buy coffee ---
buyCoffeeBtn.onclick = async () => {
  if(!walletPublicKey) return;

  try {
    const coffeePriceSOL = parseFloat(buyCoffeeBtn.dataset.coffeePriceSOL);
    const platformFeeSOL = parseFloat(buyCoffeeBtn.dataset.platformFeeSOL);
    const creatorWallet = new PublicKey(buyCoffeeBtn.dataset.creatorWallet);

    const transaction = new Transaction().add(
      SystemProgram.transfer({
        fromPubkey: walletPublicKey,
        toPubkey: creatorWallet,
        lamports: coffeePriceSOL * LAMPORTS_PER_SOL
      }),
      SystemProgram.transfer({
        fromPubkey: walletPublicKey,
        toPubkey: new PublicKey(PLATFORM_WALLET),
        lamports: platformFeeSOL * LAMPORTS_PER_SOL
      })
    );

    const { signature } = await window.solana.signAndSendTransaction(transaction);
    console.log("Payment successful:", signature);
    thankYouMsg.style.display = "block";
  } catch(err) {
    console.error(err);
    alert("Transaction failed");
  }
};

// --- Init ---
window.addEventListener("load", loadCreatorProfile);
</script>

</body>
  </html>
